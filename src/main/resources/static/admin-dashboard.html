<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeatSaga Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
            --gray-color: #9ca3af;
            --sidebar-width: 280px;
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        /* Header */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
        }

        /* Sidebar */
        .sidebar {
            min-height: calc(100vh - 56px);
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            color: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 4px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            color: white;
            background: var(--primary-color);
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.2);
        }

        .sidebar .nav-link i {
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            background: #f5f7fa;
        }

        /* Cards */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1.25rem 1.5rem;
        }

        /* Tables */
        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            color: #4b5563;
            padding: 1rem;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #f3f4f6;
        }

        .table tbody tr:hover {
            background-color: #f9fafb;
        }

        /* Badges */
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 8px 16px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #0da67b 100%);
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            border: none;
        }

        /* Breadcrumb */
        .breadcrumb {
            background: none;
            padding: 0.75rem 0;
            margin-bottom: 1.5rem;
        }

        .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .breadcrumb-item.active {
            color: #6b7280;
            font-weight: 600;
        }

        /* Alerts */
        #alert-area {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            width: 350px;
        }

        .alert {
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Section Transitions */
        .section-view {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modals */
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            background-color: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        /* Form Controls */
        .form-control, .form-select {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px 12px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Tabs */
        .nav-tabs {
            border-bottom: 2px solid #e5e7eb;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6b7280;
            font-weight: 500;
            padding: 12px 20px;
            margin-right: 4px;
            border-radius: 8px 8px 0 0;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: #f3f4f6;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
            #alert-area {
                width: 90%;
                left: 5%;
                right: 5%;
            }
        }

        /* Seat Layout Preview */
        .seat-layout-preview {
            background: #f8fafc;
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .seat-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .seat {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .seat.regular { background: #dbeafe; color: #1d4ed8; }
        .seat.premium { background: #fef3c7; color: #92400e; }
        .seat.recliner { background: #d1fae5; color: #065f46; }
        .seat.vip { background: #f3e8ff; color: #6b21a8; }

        .seat:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="bi bi-ticket-perforated me-2"></i>
            SeatSaga Admin
        </a>
        <div class="d-flex gap-2">
            <a href="dashboard.html" class="btn btn-outline-light btn-sm">
                <i class="bi bi-speedometer2 me-1"></i> Main Dashboard
            </a>
            <button class="btn btn-light btn-sm" onclick="logout()">
                <i class="bi bi-box-arrow-right me-1"></i> Logout
            </button>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-2 p-0">
            <div class="sidebar p-3">
                <div class="d-flex align-items-center mb-4 px-2">
                    <div class="me-3">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-person-fill text-white"></i>
                        </div>
                    </div>
                    <div>
                        <div class="fw-bold" id="admin-name">Admin User</div>
                        <small class="text-muted">Administrator</small>
                    </div>
                </div>

                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" onclick="showSection('movies-section')">
                            <i class="bi bi-film me-2"></i> Movies
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('partners-section')">
                            <i class="bi bi-building me-2"></i> Partners
                        </a>
                    </li>
                </ul>

                <div class="mt-5 px-2">
                    <small class="text-muted">SYSTEM STATUS</small>
                    <div class="d-flex align-items-center mt-2">
                        <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                        <small class="text-white">All Systems Operational</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-10 main-content">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb" id="breadcrumbs">
                    <li class="breadcrumb-item active">Movies</li>
                </ol>
            </nav>

            <div id="alert-area"></div>

            <!-- Movies Section -->
            <div id="movies-section" class="section-view active">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold mb-2"><i class="bi bi-film text-primary me-2"></i> Manage Movies</h2>
                        <p class="text-muted mb-0">Add, edit, and manage movie listings</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('movieModal')">
                        <i class="bi bi-plus-lg me-1"></i> Add Movie
                    </button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Genre</th>
                                    <th>Duration</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="movies-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Partners Section -->
            <div id="partners-section" class="section-view">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold mb-2"><i class="bi bi-building text-primary me-2"></i> Manage Partners</h2>
                        <p class="text-muted mb-0">Manage theatre partners and their API keys</p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('partnerModal')">
                        <i class="bi bi-plus-lg me-1"></i> Add Partner
                    </button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>API Key</th>
                                    <th>Status</th>
                                    <th>Management</th>
                                    <th style="width: 80px;">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="partners-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theatres Section -->
            <div id="theatres-section" class="section-view">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold mb-2"><i class="bi bi-geo-alt text-primary me-2"></i> Theatres</h2>
                        <p class="text-muted mb-0" id="theatre-partner-name"></p>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('theatreModal')">
                        <i class="bi bi-plus-lg me-1"></i> Add Theatre
                    </button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>City</th>
                                    <th>Address</th>
                                    <th>Screens</th>
                                    <th>Operations</th>
                                    <th style="width: 80px;">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="theatres-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theatre Dashboard Section -->
            <div id="theatre-dashboard-section" class="section-view">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold mb-2"><i class="bi bi-display text-primary me-2"></i> Theatre Operations</h2>
                        <p class="text-primary fw-bold mb-0" id="dashboard-theatre-name"></p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="theatreTab" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" id="screens-tab" data-bs-toggle="tab" data-bs-target="#screens-pane">
                                    <i class="bi bi-aspect-ratio me-1"></i> Screens
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="shows-tab" data-bs-toggle="tab" data-bs-target="#shows-pane" onclick="loadShows()">
                                    <i class="bi bi-calendar-event me-1"></i> Shows
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="screens-pane">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h5 class="mb-0">Screen Management</h5>
                                        <small class="text-muted">Manage screens and seat layouts</small>
                                    </div>
                                    <button class="btn btn-success" onclick="openModal('screenModal')">
                                        <i class="bi bi-plus-lg me-1"></i> Add Screen
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Total Seats</th>
                                            <th>Layout</th>
                                            <th>Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody id="screens-table-body"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="shows-pane">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h5 class="mb-0">Show Schedule</h5>
                                        <small class="text-muted">Manage movie shows and timings</small>
                                    </div>
                                    <button class="btn btn-success" onclick="prepareAddShowModal()">
                                        <i class="bi bi-plus-lg me-1"></i> Add Show
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Movie</th>
                                            <th>Screen</th>
                                            <th>Time</th>
                                            <th>Price</th>
                                            <th>Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody id="shows-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Movie Modal -->
<div class="modal fade" id="movieModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-film me-2"></i> Save Movie</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="movieForm">
                    <input type="hidden" id="movieId">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Title</label>
                        <input type="text" class="form-control" id="movieTitle" placeholder="Enter movie title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Genre</label>
                        <input type="text" class="form-control" id="movieGenre" placeholder="e.g., Action, Drama">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Duration (minutes)</label>
                            <input type="number" class="form-control" id="movieDuration" placeholder="120" required>
                        </div>

                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Description</label>
                        <textarea class="form-control" id="movieDesc" rows="3" placeholder="Movie synopsis..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMovie()">
                    <i class="bi bi-save me-1"></i> Save Movie
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Partner Modal -->
<div class="modal fade" id="partnerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-building me-2"></i> Save Partner</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="partnerForm">
                    <input type="hidden" id="partnerId">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Company Name</label>
                        <input type="text" class="form-control" id="partnerName" placeholder="Enter company name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Contact Email</label>
                        <input type="email" class="form-control" id="partnerEmail" placeholder="contact@company.com" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">API Key</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="partnerApiKey" placeholder="Auto-generated" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="generateApiKey()">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </div>
                        <small class="text-muted">Click generate to create a new API key</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePartner()">
                    <i class="bi bi-save me-1"></i> Save Partner
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Theatre Modal -->
<div class="modal fade" id="theatreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-geo-alt me-2"></i> Save Theatre</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="theatreForm">
                    <input type="hidden" id="theatreId">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Theatre Name</label>
                        <input type="text" class="form-control" id="theatreName" placeholder="e.g., PVR Cinemas" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">City</label>
                            <input type="text" class="form-control" id="theatreCity" placeholder="e.g., Bengaluru" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">State</label>
                            <input type="text" class="form-control" id="theatreState" placeholder="e.g., Karnataka">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Address</label>
                        <textarea class="form-control" id="theatreAddress" rows="2" placeholder="Full address..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTheatre()">
                    <i class="bi bi-save me-1"></i> Save Theatre
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Screen Modal (Updated with Seat Layout) -->
<div class="modal fade" id="screenModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-aspect-ratio me-2"></i> Save Screen</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="screenForm">
                    <input type="hidden" id="screenId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Screen Name</label>
                                <input type="text" class="form-control" id="screenName" placeholder="e.g., Screen 1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Total Seats</label>
                                <input type="number" class="form-control" id="screenSeats" min="1" value="10" required>
                                <small class="text-muted">Total number of seats in this screen</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Seat Layout Configuration</label>
                                <div id="seatLayoutBuilder">
                                    <div class="row mb-2">
                                        <div class="col-4">
                                            <input type="text" class="form-control form-control-sm seat-row-letter" placeholder="Row (A, B, C)" maxlength="2">
                                        </div>
                                        <div class="col-4">
                                            <input type="number" class="form-control form-control-sm seat-count" placeholder="Seats" min="1" max="30">
                                        </div>
                                        <div class="col-4">
                                            <select class="form-select form-select-sm seat-type">
                                                <option value="REGULAR">Regular</option>
                                                <option value="PREMIUM">Premium</option>
                                                <option value="RECLINER">Recliner</option>
                                                <option value="VIP">VIP</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="additionalRows"></div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSeatRow()">
                                        <i class="bi bi-plus-circle me-1"></i> Add Row
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Layout Preview</label>
                            <div class="seat-layout-preview" id="seatLayoutPreview">
                                <div class="text-muted mb-3">Add rows to see preview</div>
                                <small class="text-muted">Seat colors: <span class="badge regular">Regular</span> <span class="badge premium">Premium</span> <span class="badge recliner">Recliner</span> <span class="badge vip">VIP</span></small>
                            </div>
                            <div class="mt-3">
                                <label class="form-label fw-semibold">Or use JSON configuration</label>
                                <textarea class="form-control" id="seatLayoutJson" rows="6" placeholder='{
  "rows": [
    {"row": "A", "seatCount": 5, "seatType": "REGULAR"},
    {"row": "B", "seatCount": 5, "seatType": "PREMIUM"},
    {"row": "C", "seatCount": 8, "seatType": "RECLINER"}
  ]
}'></textarea>
                                <small class="text-muted">Leave empty to use row-by-row configuration above</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveScreen()">
                    <i class="bi bi-save me-1"></i> Save Screen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Show Modal -->
<div class="modal fade" id="showModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-event me-2"></i> Add New Show</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="showForm">
                    <input type="hidden" id="showId">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Screen</label>
                        <select class="form-select" id="showScreenSelect" required>
                            <option value="">Choose a screen</option>
                        </select>
                        <small class="text-muted">Shows are attached to specific screens</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Movie</label>
                        <select class="form-select" id="showMovieSelect" required>
                            <option value="">Choose a movie</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Start Time</label>
                            <input type="datetime-local" class="form-control" id="showStartTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">End Time</label>
                            <input type="datetime-local" class="form-control" id="showEndTime" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Base Price ($)</label>
                        <input type="number" class="form-control" id="showPrice" step="0.01" placeholder="10.00" required>
                        <small class="text-muted">Additional charges will apply based on seat type</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveShow()">
                    <i class="bi bi-plus-lg me-1"></i> Create Show
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Configuration
    const API_BASE = '/api';

    // State Management
    let currentPartnerId = null;
    let currentTheatreId = null;
    let globalMovies = [];
    let globalScreens = [];
    let globalPartners = [];
    let globalTheatres = [];

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        loadMovies();
        loadPartners();
        // Load admin name if available
        const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
        if(user.name) {
            document.getElementById('admin-name').textContent = user.name;
        }
    });

    // --- Navigation & Utility ---
    function logout() {
        if(confirm("Are you sure you want to logout?")) {
            localStorage.removeItem('admin_token');
            window.location.href = 'index.html';
        }
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('admin_token') || ''}`
            }
        };
        if (body) options.body = JSON.stringify(body);

        try {
            const res = await fetch(`${API_BASE}${endpoint}`, options);
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.message || `Request failed: ${res.status}`);
            }
            if (res.status === 204) return null;
            return await res.json();
        } catch (err) {
            showAlert('danger', err.message);
            console.error(err);
            return null;
        }
    }

    function showAlert(type, msg) {
        const div = document.createElement('div');
        div.className = `alert alert-${type} alert-dismissible fade show`;
        div.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'danger' ? 'bi-x-circle' : 'bi-info-circle'} me-2 fs-5"></i>
                <div>${msg}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.getElementById('alert-area').appendChild(div);
        setTimeout(() => {
            if(div.parentNode) div.remove();
        }, 5000);
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

        document.getElementById(sectionId).classList.add('active');

        // Update Sidebar highlighting
        if(sectionId === 'movies-section') {
            document.querySelector('.nav-link[onclick="showSection(\'movies-section\')"]').classList.add('active');
            updateBreadcrumb('Movies');
        } else if(sectionId === 'partners-section') {
            document.querySelector('.nav-link[onclick="showSection(\'partners-section\')"]').classList.add('active');
            updateBreadcrumb('Partners');
        }
    }

    function updateBreadcrumb(text, append = false, onClickFn = null) {
        const bc = document.getElementById('breadcrumbs');
        if(!append) {
            bc.innerHTML = `<li class="breadcrumb-item active">${text}</li>`;
        } else {
            const last = bc.lastElementChild;
            last.classList.remove('active');
            const oldText = last.innerText;
            if(onClickFn) {
                last.innerHTML = `<a onclick="${onClickFn}" class="text-decoration-none">${oldText}</a>`;
            }
            bc.innerHTML += `<li class="breadcrumb-item active">${text}</li>`;
        }
    }

    function openModal(id) {
        const form = document.querySelector(`#${id} form`);
        if(form) {
            form.reset();
            const hiddenId = form.querySelector('input[type="hidden"]');
            if(hiddenId) hiddenId.value = '';

            // Reset seat layout builder for screen modal
            if(id === 'screenModal') {
                resetSeatLayoutBuilder();
            }
        }
        new bootstrap.Modal(document.getElementById(id)).show();
    }

    // --- Seat Layout Builder Functions ---
    function addSeatRow() {
        const container = document.getElementById('additionalRows');
        const rowCount = container.children.length + 1;
        const rowLetter = String.fromCharCode(65 + rowCount); // A, B, C, etc

        const rowHtml = `
            <div class="row mb-2" data-row="${rowLetter}">
                <div class="col-4">
                    <input type="text" class="form-control form-control-sm seat-row-letter"
                           value="${rowLetter}" placeholder="Row" maxlength="2" readonly>
                </div>
                <div class="col-4">
                    <input type="number" class="form-control form-control-sm seat-count"
                           placeholder="Seats" min="1" max="30" value="5" onchange="updateSeatPreview()">
                </div>
                <div class="col-4">
                    <select class="form-select form-select-sm seat-type" onchange="updateSeatPreview()">
                        <option value="REGULAR">Regular</option>
                        <option value="PREMIUM">Premium</option>
                        <option value="RECLINER">Recliner</option>
                        <option value="VIP">VIP</option>
                    </select>
                </div>
            </div>
        `;
        container.innerHTML += rowHtml;
        updateSeatPreview();
    }

    function resetSeatLayoutBuilder() {
        document.getElementById('additionalRows').innerHTML = '';
        document.getElementById('seatLayoutJson').value = '';
        updateSeatPreview();
    }

    function updateSeatPreview() {
        const preview = document.getElementById('seatLayoutPreview');
        preview.innerHTML = '';

        // Get rows from builder
        const rows = [];

        // First row
        const firstRowLetter = document.querySelector('.seat-row-letter').value;
        const firstSeatCount = document.querySelector('.seat-count').value;
        const firstSeatType = document.querySelector('.seat-type').value;

        if(firstRowLetter && firstSeatCount > 0) {
            rows.push({
                row: firstRowLetter,
                seatCount: parseInt(firstSeatCount),
                seatType: firstSeatType
            });
        }

        // Additional rows
        const additionalRows = document.querySelectorAll('#additionalRows .row');
        additionalRows.forEach(rowDiv => {
            const rowLetter = rowDiv.querySelector('.seat-row-letter').value;
            const seatCount = rowDiv.querySelector('.seat-count').value;
            const seatType = rowDiv.querySelector('.seat-type').value;

            if(rowLetter && seatCount > 0) {
                rows.push({
                    row: rowLetter,
                    seatCount: parseInt(seatCount),
                    seatType: seatType
                });
            }
        });

        if(rows.length === 0) {
            preview.innerHTML = '<div class="text-muted">Add rows to see preview</div>';
            return;
        }

        // Calculate total seats
        let totalSeats = 0;
        rows.forEach(r => totalSeats += r.seatCount);
        document.getElementById('screenSeats').value = totalSeats;

        // Generate preview
        rows.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'seat-row mb-2';

            // Row label
            const label = document.createElement('div');
            label.className = 'me-2 fw-bold';
            label.style.width = '20px';
            label.textContent = row.row;
            rowDiv.appendChild(label);

            // Seats
            for(let i = 1; i <= row.seatCount; i++) {
                const seat = document.createElement('div');
                seat.className = `seat ${row.seatType.toLowerCase()}`;
                seat.textContent = i;
                seat.title = `${row.row}${i} - ${row.seatType}`;
                rowDiv.appendChild(seat);
            }

            preview.appendChild(rowDiv);
        });

        // Update JSON
        updateLayoutJson(rows);
    }

    function updateLayoutJson(rows) {
        const jsonTextarea = document.getElementById('seatLayoutJson');
        const layout = { rows: rows };
        jsonTextarea.value = JSON.stringify(layout, null, 2);
    }

    // --- Movies Logic ---
    async function loadMovies() {
        const data = await apiCall('/movies');
        if (data) {
            globalMovies = data;
            const tbody = document.getElementById('movies-table-body');
            tbody.innerHTML = data.map(m => `
                <tr>
                    <td><span class="badge bg-light text-dark">#${m.id}</span></td>
                    <td>
                        <div class="fw-semibold">${m.title}</div>
                        <small class="text-muted">${m.description ? m.description.substring(0, 50) + '...' : 'No description'}</small>
                    </td>
                    <td><span class="badge bg-primary">${m.genre || 'N/A'}</span></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-clock me-1"></i>
                            <span>${m.durationMinutes} min</span>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editMovie(${m.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }

    function editMovie(id) {
        const m = globalMovies.find(x => x.id === id);
        if(!m) return;
        document.getElementById('movieId').value = m.id;
        document.getElementById('movieTitle').value = m.title;
        document.getElementById('movieGenre').value = m.genre || '';
        document.getElementById('movieDuration').value = m.durationMinutes;
        document.getElementById('movieDesc').value = m.description || '';
        new bootstrap.Modal(document.getElementById('movieModal')).show();
    }


    async function saveMovie() {
        const id = document.getElementById('movieId').value;
        const body = {
            title: document.getElementById('movieTitle').value.trim(),
            genre: document.getElementById('movieGenre').value.trim(),
            durationMinutes: parseInt(document.getElementById('movieDuration').value) || 120,
            description: document.getElementById('movieDesc').value.trim()
        };

        if(!body.title) {
            showAlert('warning', 'Please enter a movie title');
            return;
        }

        // Add required fields that might be missing
        if (!body.genre) body.genre = "General";
        if (!body.description) body.description = "No description available";

        console.log("Saving movie:", body); // Debug log

        const res = await apiCall(id ? `/movies/${id}` : '/movies', id ? 'PUT' : 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('movieModal')).hide();
            loadMovies();
            showAlert('success', `Movie ${id ? 'updated' : 'added'} successfully`);
        }
    }

    // --- Partner Logic ---
    async function loadPartners() {
        const data = await apiCall('/partners');
        if (data) {
            globalPartners = data;
            const tbody = document.getElementById('partners-table-body');
            tbody.innerHTML = data.map(p => `
                <tr>
                    <td><span class="badge bg-light text-dark">#${p.id}</span></td>
                    <td>
                        <div class="fw-semibold text-primary">${p.name}</div>
                        <small class="text-muted">Partner ID: ${p.id}</small>
                    </td>
                    <td>${p.contactEmail}</td>
                    <td>
                        <code class="bg-light p-1 rounded">${p.apiKey.substring(0, 10)}...</code>
                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyToClipboard('${p.apiKey}')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </td>
                    <td>
                        <span class="badge ${p.isActive ? 'bg-success' : 'bg-secondary'}">
                            ${p.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewTheatres(${p.id}, '${p.name}')">
                            <i class="bi bi-geo-alt me-1"></i> Theatres
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editPartner(${p.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePartner(${p.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }

    function editPartner(id) {
        const p = globalPartners.find(x => x.id === id);
        document.getElementById('partnerId').value = p.id;
        document.getElementById('partnerName').value = p.name;
        document.getElementById('partnerEmail').value = p.contactEmail;
        document.getElementById('partnerApiKey').value = p.apiKey;
        new bootstrap.Modal(document.getElementById('partnerModal')).show();
    }

    function generateApiKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let apiKey = 'pk_';
        for(let i = 0; i < 32; i++) {
            apiKey += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('partnerApiKey').value = apiKey;
    }

    async function savePartner() {
        const id = document.getElementById('partnerId').value;
        const body = {
            name: document.getElementById('partnerName').value.trim(),
            contactEmail: document.getElementById('partnerEmail').value.trim(),
            apiKey: document.getElementById('partnerApiKey').value.trim()
        };

        if(!body.name || !body.contactEmail || !body.apiKey) {
            showAlert('warning', 'Please fill all required fields');
            return;
        }

        const res = await apiCall(id ? `/partners/${id}` : '/partners', id ? 'PUT' : 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('partnerModal')).hide();
            loadPartners();
            showAlert('success', `Partner ${id ? 'updated' : 'added'} successfully`);
        }
    }

    async function deletePartner(id) {
        if(!confirm("Are you sure you want to delete this partner? This will also delete all associated theatres.")) return;
        const res = await apiCall(`/partners/${id}`, 'DELETE');
        if(res) {
            loadPartners();
            showAlert('warning', 'Partner deleted successfully');
        }
    }

    // --- Theatre Logic ---
    async function viewTheatres(partnerId, partnerName) {
        currentPartnerId = partnerId;
        document.getElementById('theatre-partner-name').innerText = `Partner: ${partnerName}`;

        const bc = document.getElementById('breadcrumbs');
        bc.innerHTML = `
            <li class="breadcrumb-item"><a onclick="showSection('partners-section')" class="text-decoration-none">Partners</a></li>
            <li class="breadcrumb-item active">${partnerName}</li>
        `;

        showSection('theatres-section');
        loadTheatres();
    }

    async function loadTheatres() {
        const data = await apiCall(`/partners/${currentPartnerId}/theatres`);
        if(data) {
            globalTheatres = data;
            const tbody = document.getElementById('theatres-table-body');
            tbody.innerHTML = data.map(t => `
                <tr>
                    <td><span class="badge bg-light text-dark">#${t.id}</span></td>
                    <td>
                        <div class="fw-semibold">${t.name}</div>
                        <small class="text-muted">ID: ${t.id}</small>
                    </td>
                    <td>
                        <span class="badge bg-info">${t.city}</span>
                    </td>
                    <td>
                        <small>${t.address || 'No address'}</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${t.screens ? t.screens.length : 0} screens</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewTheatreDashboard(${t.id}, '${t.name}')">
                            <i class="bi bi-gear me-1"></i> Manage
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editTheatre(${t.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTheatre(${t.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }

    function editTheatre(id) {
        const t = globalTheatres.find(x => x.id === id);
        document.getElementById('theatreId').value = t.id;
        document.getElementById('theatreName').value = t.name;
        document.getElementById('theatreCity').value = t.city;
        document.getElementById('theatreAddress').value = t.address || '';
        new bootstrap.Modal(document.getElementById('theatreModal')).show();
    }

    async function saveTheatre() {
        const id = document.getElementById('theatreId').value;
        const body = {
            name: document.getElementById('theatreName').value.trim(),
            city: document.getElementById('theatreCity').value.trim(),
            address: document.getElementById('theatreAddress').value.trim()
        };

        if(!body.name || !body.city) {
            showAlert('warning', 'Please fill all required fields');
            return;
        }

        const url = id ? `/partners/${currentPartnerId}/theatres/${id}` : `/partners/${currentPartnerId}/theatres`;
        const res = await apiCall(url, id ? 'PUT' : 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('theatreModal')).hide();
            loadTheatres();
            showAlert('success', `Theatre ${id ? 'updated' : 'added'} successfully`);
        }
    }

    async function deleteTheatre(id) {
        if(!confirm("Are you sure you want to delete this theatre? This will also delete all screens and shows.")) return;
        const res = await apiCall(`/partners/${currentPartnerId}/theatres/${id}`, 'DELETE');
        if(res) {
            loadTheatres();
            showAlert('warning', 'Theatre deleted successfully');
        }
    }

    // --- Screens & Shows Dashboard ---
    async function viewTheatreDashboard(theatreId, theatreName) {
        currentTheatreId = theatreId;
        document.getElementById('dashboard-theatre-name').innerText = theatreName;

        const bc = document.getElementById('breadcrumbs');
        bc.innerHTML = `
            <li class="breadcrumb-item"><a onclick="showSection('partners-section')" class="text-decoration-none">Partners</a></li>
            <li class="breadcrumb-item"><a onclick="viewTheatres(${currentPartnerId}, '${globalPartners.find(p => p.id === currentPartnerId)?.name}')" class="text-decoration-none">Theatres</a></li>
            <li class="breadcrumb-item active">${theatreName}</li>
        `;

        showSection('theatre-dashboard-section');
        new bootstrap.Tab(document.querySelector('#screens-tab')).show();
        loadScreens();
    }

    // --- Screens Logic ---
    async function loadScreens() {
        const data = await apiCall(`/theatres/${currentTheatreId}/screens`);
        if(data) {
            globalScreens = data;
            const tbody = document.getElementById('screens-table-body');
            tbody.innerHTML = data.map(s => `
                <tr>
                    <td><span class="badge bg-light text-dark">#${s.id}</span></td>
                    <td>
                        <div class="fw-semibold">${s.name}</div>
                        <small class="text-muted">ID: ${s.id}</small>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-people me-1"></i>
                            <span>${s.totalSeats} seats</span>
                        </div>
                    </td>
                    <td>
                        ${s.seatLayoutJson ?
                '<span class="badge bg-success">Custom layout</span>' :
                '<span class="badge bg-secondary">Default layout</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editScreen(${s.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteScreen(${s.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }

    function editScreen(id) {
        const s = globalScreens.find(x => x.id === id);
        document.getElementById('screenId').value = s.id;
        document.getElementById('screenName').value = s.name;
        document.getElementById('screenSeats').value = s.totalSeats;
        document.getElementById('seatLayoutJson').value = s.seatLayoutJson || '';

        // Parse and populate seat layout builder if JSON exists
        if(s.seatLayoutJson) {
            try {
                const layout = JSON.parse(s.seatLayoutJson);
                if(layout.rows && layout.rows.length > 0) {
                    resetSeatLayoutBuilder();
                    // Populate builder with existing rows
                    layout.rows.forEach((row, index) => {
                        if(index === 0) {
                            document.querySelector('.seat-row-letter').value = row.row;
                            document.querySelector('.seat-count').value = row.seatCount;
                            document.querySelector('.seat-type').value = row.seatType;
                        } else {
                            addSeatRow();
                            const lastRow = document.querySelector('#additionalRows .row:last-child');
                            lastRow.querySelector('.seat-row-letter').value = row.row;
                            lastRow.querySelector('.seat-count').value = row.seatCount;
                            lastRow.querySelector('.seat-type').value = row.seatType;
                        }
                    });
                    updateSeatPreview();
                }
            } catch(e) {
                console.error('Error parsing seat layout JSON:', e);
            }
        }

        new bootstrap.Modal(document.getElementById('screenModal')).show();
    }

    async function saveScreen() {
        const id = document.getElementById('screenId').value;
        const screenName = document.getElementById('screenName').value.trim();
        const totalSeats = parseInt(document.getElementById('screenSeats').value);
        let seatLayoutJson = document.getElementById('seatLayoutJson').value.trim();

        if(!screenName || !totalSeats || totalSeats <= 0) {
            showAlert('warning', 'Please provide valid screen name and seat count');
            return;
        }

        // If seatLayoutJson is empty, generate from builder
        if(!seatLayoutJson) {
            const rows = [];
            // First row
            const firstRowLetter = document.querySelector('.seat-row-letter').value;
            const firstSeatCount = document.querySelector('.seat-count').value;
            const firstSeatType = document.querySelector('.seat-type').value;

            if(firstRowLetter && firstSeatCount > 0) {
                rows.push({
                    row: firstRowLetter,
                    seatCount: parseInt(firstSeatCount),
                    seatType: firstSeatType
                });
            }

            // Additional rows
            const additionalRows = document.querySelectorAll('#additionalRows .row');
            additionalRows.forEach(rowDiv => {
                const rowLetter = rowDiv.querySelector('.seat-row-letter').value;
                const seatCount = rowDiv.querySelector('.seat-count').value;
                const seatType = rowDiv.querySelector('.seat-type').value;

                if(rowLetter && seatCount > 0) {
                    rows.push({
                        row: rowLetter,
                        seatCount: parseInt(seatCount),
                        seatType: seatType
                    });
                }
            });

            if(rows.length > 0) {
                seatLayoutJson = JSON.stringify({ rows: rows });
            }
        }

        const body = {
            name: screenName,
            totalSeats: totalSeats,
            seatLayoutJson: seatLayoutJson || null
        };

        const url = id ? `/theatres/${currentTheatreId}/screens/${id}` : `/theatres/${currentTheatreId}/screens`;
        const res = await apiCall(url, id ? 'PUT' : 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('screenModal')).hide();
            loadScreens();
            showAlert('success', `Screen ${id ? 'updated' : 'added'} successfully`);
        }
    }

    async function deleteScreen(id) {
        if(!confirm("Are you sure you want to delete this screen? This will also delete all shows scheduled for this screen.")) return;
        const res = await apiCall(`/theatres/${currentTheatreId}/screens/${id}`, 'DELETE');
        if(res) {
            loadScreens();
            showAlert('warning', 'Screen deleted successfully');
        }
    }

    // --- Shows Logic ---
    async function loadShows() {
        const data = await apiCall(`/partners/${currentPartnerId}/theatres/${currentTheatreId}/shows`);
        if(data) {
            const tbody = document.getElementById('shows-table-body');
            tbody.innerHTML = data.map(s => {
                const movie = globalMovies.find(m => m.id === s.movieId);
                const screen = globalScreens.find(sc => sc.id === s.screenId);
                const mTitle = movie ? movie.title : `Movie #${s.movieId}`;
                const sName = screen ? screen.name : `Screen #${s.screenId}`;
                const start = new Date(s.startTime).toLocaleString('en-US', {
                    weekday:'short',
                    month:'short',
                    day:'numeric',
                    hour:'numeric',
                    minute:'2-digit'
                });

                return `
                <tr>
                    <td><span class="badge bg-light text-dark">#${s.id}</span></td>
                    <td>
                        <div class="fw-semibold">${mTitle}</div>
                        <small class="text-muted">ID: ${s.movieId}</small>
                    </td>
                    <td>${sName}</td>
                    <td>
                        <div class="fw-medium">${start}</div>
                        <small class="text-muted">${new Date(s.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                    </td>
                    <td>
                        <span class="badge bg-success">$${s.basePrice}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteShow(${s.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }
    }

    function prepareAddShowModal() {
        if(!globalScreens.length) {
            showAlert('warning', "No screens found! Please add screens to this theatre first.");
            return;
        }

        const screenSelect = document.getElementById('showScreenSelect');
        const movieSelect = document.getElementById('showMovieSelect');

        screenSelect.innerHTML = '<option value="">Choose a screen</option>' +
            globalScreens.map(s => `<option value="${s.id}">${s.name} (${s.totalSeats} seats)</option>`).join('');
        movieSelect.innerHTML = '<option value="">Choose a movie</option>' +
            globalMovies.map(m => `<option value="${m.id}">${m.title} (${m.durationMinutes} min)</option>`).join('');

        // Set default times
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(18, 0, 0, 0); // 6 PM tomorrow

        const endTime = new Date(tomorrow);
        endTime.setHours(20, 30, 0, 0); // 8:30 PM

        document.getElementById('showStartTime').value = tomorrow.toISOString().slice(0, 16);
        document.getElementById('showEndTime').value = endTime.toISOString().slice(0, 16);
        document.getElementById('showPrice').value = '15.00';

        openModal('showModal');
    }

    async function saveShow() {
        const screenId = document.getElementById('showScreenSelect').value;
        const movieId = document.getElementById('showMovieSelect').value;
        const startTime = document.getElementById('showStartTime').value;
        const endTime = document.getElementById('showEndTime').value;
        const basePrice = document.getElementById('showPrice').value;

        if(!screenId || !movieId || !startTime || !endTime || !basePrice) {
            showAlert('warning', 'Please fill all required fields');
            return;
        }

        if(new Date(startTime) >= new Date(endTime)) {
            showAlert('warning', 'End time must be after start time');
            return;
        }

        const body = {
            movieId: parseInt(movieId),
            startTime: startTime + ':00',
            endTime: endTime + ':00',
            basePrice: parseFloat(basePrice)
        };

        const url = `/partners/${currentPartnerId}/theatres/${currentTheatreId}/screens/${screenId}/shows`;
        const res = await apiCall(url, 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('showModal')).hide();
            loadShows();
            showAlert('success', 'Show created successfully');
        }
    }

    async function deleteShow(showId) {
        if(!confirm("Are you sure you want to delete this show?")) return;
        const res = await apiCall(`/partners/${currentPartnerId}/theatres/${currentTheatreId}/shows/${showId}`, 'DELETE');
        if(res) {
            loadShows();
            showAlert('warning', 'Show deleted successfully');
        }
    }

    // --- Utility Functions ---
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showAlert('success', 'API key copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            showAlert('danger', 'Failed to copy to clipboard');
        });
    }

</script>
</body>
</html>