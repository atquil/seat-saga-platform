<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeatSaga Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { min-height: 100vh; background-color: #212529; color: white; }
        /* ðŸŸ¢ NEW (Fixes the bug) */
        /* Only target nav-links inside the sidebar */
        .sidebar .nav-link {
            color: rgba(255,255,255,.8);
            cursor: pointer;
            padding: 12px 20px;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: #fff;
            background-color: #343a40;
            border-left: 4px solid #0d6efd;
        }

        /* Ensure standard Tabs look normal (Blue text, standard Bootstrap) */
        .nav-tabs .nav-link {
            color: #0d6efd; /* Standard Bootstrap Blue */
        }
        .nav-tabs .nav-link.active {
            color: #495057;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: none; }
        .breadcrumb-item a { text-decoration: none; cursor: pointer; color: #0d6efd; }
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .top-bar { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 10px 20px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="bi bi-film"></i> SeatSaga Admin</a>
        <div class="d-flex gap-2">
            <a href="dashboard.html" class="btn btn-outline-light btn-sm">
                <i class="bi bi-arrow-left-circle"></i> Back to Main Dashboard
            </a>
            <button class="btn btn-danger btn-sm" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar p-0 pt-3">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('movies-section')"><i class="bi bi-camera-reels me-2"></i> Movies</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('partners-section')"><i class="bi bi-building me-2"></i> Partners</a>
                </li>
            </ul>
        </div>

        <div class="col-md-10 p-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb" id="breadcrumbs">
                    <li class="breadcrumb-item active">Movies</li>
                </ol>
            </nav>

            <div id="alert-area"></div>

            <div id="movies-section" class="section-view active">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="bi bi-film"></i> Manage Movies</h2>
                    <button class="btn btn-primary" onclick="openModal('movieModal')"><i class="bi bi-plus-lg"></i> Add Movie</button>
                </div>
                <div class="card p-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>ID</th><th>Title</th><th>Genre</th><th>Duration</th><th>Actions</th></tr></thead>
                        <tbody id="movies-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="partners-section" class="section-view">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="bi bi-briefcase"></i> Manage Partners</h2>
                    <button class="btn btn-primary" onclick="openModal('partnerModal')"><i class="bi bi-plus-lg"></i> Add Partner</button>
                </div>
                <div class="card p-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Email</th><th>API Key</th><th>Management</th><th>Actions</th></tr></thead>
                        <tbody id="partners-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="theatres-section" class="section-view">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2><i class="bi bi-geo-alt"></i> Theatres</h2>
                        <span id="theatre-partner-name" class="text-muted"></span>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('theatreModal')"><i class="bi bi-plus-lg"></i> Add Theatre</button>
                </div>
                <div class="card p-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>ID</th><th>Name</th><th>City</th><th>Address</th><th>Operations</th><th>Actions</th></tr></thead>
                        <tbody id="theatres-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="theatre-dashboard-section" class="section-view">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2><i class="bi bi-display"></i> Theatre Operations</h2>
                        <span id="dashboard-theatre-name" class="text-primary fw-bold"></span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="theatreTab" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" id="screens-tab" data-bs-toggle="tab" data-bs-target="#screens-pane" type="button"><i class="bi bi-aspect-ratio"></i> Screens</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="shows-tab" data-bs-toggle="tab" data-bs-target="#shows-pane" type="button" onclick="loadShows()"><i class="bi bi-calendar-event"></i> Shows</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="screens-pane">
                                <div class="d-flex justify-content-end mb-3">
                                    <button class="btn btn-success btn-sm" onclick="openModal('screenModal')"><i class="bi bi-plus-lg"></i> Add Screen</button>
                                </div>
                                <table class="table table-bordered">
                                    <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Total Seats</th><th>Actions</th></tr></thead>
                                    <tbody id="screens-table-body"></tbody>
                                </table>
                            </div>

                            <div class="tab-pane fade" id="shows-pane">
                                <div class="d-flex justify-content-end mb-3">
                                    <button class="btn btn-success btn-sm" onclick="prepareAddShowModal()"><i class="bi bi-plus-lg"></i> Add Show</button>
                                </div>
                                <table class="table table-bordered">
                                    <thead class="table-light"><tr><th>ID</th><th>Movie</th><th>Screen</th><th>Time</th><th>Price</th><th>Actions</th></tr></thead>
                                    <tbody id="shows-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="movieModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Save Movie</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="movieForm">
                    <input type="hidden" id="movieId">
                    <div class="mb-3"><label>Title</label><input type="text" class="form-control" id="movieTitle" required></div>
                    <div class="mb-3"><label>Genre</label><input type="text" class="form-control" id="movieGenre"></div>
                    <div class="mb-3"><label>Duration (min)</label><input type="number" class="form-control" id="movieDuration" required></div>
                    <div class="mb-3"><label>Description</label><textarea class="form-control" id="movieDesc"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveMovie()">Save</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="partnerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Save Partner</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="partnerForm">
                    <input type="hidden" id="partnerId">
                    <div class="mb-3"><label>Name</label><input type="text" class="form-control" id="partnerName" required></div>
                    <div class="mb-3"><label>Contact Email</label><input type="email" class="form-control" id="partnerEmail" required></div>
                    <div class="mb-3"><label>API Key</label><input type="text" class="form-control" id="partnerApiKey" required></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="savePartner()">Save</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="theatreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Save Theatre</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="theatreForm">
                    <input type="hidden" id="theatreId">
                    <div class="mb-3"><label>Name</label><input type="text" class="form-control" id="theatreName" required></div>
                    <div class="mb-3"><label>City</label><input type="text" class="form-control" id="theatreCity" required></div>
                    <div class="mb-3"><label>Address</label><textarea class="form-control" id="theatreAddress"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveTheatre()">Save Theatre</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="screenModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Save Screen</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="screenForm">
                    <input type="hidden" id="screenId">
                    <div class="mb-3"><label>Name</label><input type="text" class="form-control" id="screenName" placeholder="e.g. Screen 1" required></div>
                    <div class="mb-3"><label>Total Seats</label><input type="number" class="form-control" id="screenSeats" value="0"></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveScreen()">Save Screen</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="showModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add New Show</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="showForm">
                    <input type="hidden" id="showId">
                    <div class="mb-3">
                        <label>Select Screen</label>
                        <select class="form-select" id="showScreenSelect" required></select>
                        <div class="form-text">Shows are attached to specific screens.</div>
                    </div>
                    <div class="mb-3">
                        <label>Select Movie</label>
                        <select class="form-select" id="showMovieSelect" required></select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3"><label>Start Time</label><input type="datetime-local" class="form-control" id="showStartTime" required></div>
                        <div class="col-6 mb-3"><label>End Time</label><input type="datetime-local" class="form-control" id="showEndTime" required></div>
                    </div>
                    <div class="mb-3"><label>Base Price ($)</label><input type="number" class="form-control" id="showPrice" step="0.01" required></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveShow()">Create Show</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Configuration
    const API_BASE = '/api';

    // State Management
    let currentPartnerId = null;
    let currentTheatreId = null;
    let globalMovies = [];
    let globalScreens = [];
    let globalPartners = [];
    let globalTheatres = [];

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        loadMovies();
        loadPartners();
    });

    // --- Navigation & Utility ---
    function logout() {
        alert("Logged out successfully!");
        window.location.href = 'index.html'; // Assuming you have a login page
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
        const options = {
            method: method,
            headers: { 'Content-Type': 'application/json' }
        };
        if (body) options.body = JSON.stringify(body);

        try {
            const res = await fetch(`${API_BASE}${endpoint}`, options);
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.message || 'Request failed');
            }
            if (res.status === 204) return null;
            return await res.json();
        } catch (err) {
            showAlert('danger', err.message);
            console.error(err);
            return null;
        }
    }

    function showAlert(type, msg) {
        const div = document.createElement('div');
        div.className = `alert alert-${type} alert-dismissible fade show`;
        div.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.getElementById('alert-area').appendChild(div);
        setTimeout(() => div.remove(), 4000);
    }

    function showSection(sectionId) {
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

        document.getElementById(sectionId).classList.add('active');

        // Update Sidebar highlighting
        if(sectionId === 'movies-section') {
            document.querySelector('.nav-link[onclick="showSection(\'movies-section\')"]').classList.add('active');
            updateBreadcrumb('Movies');
        } else if(sectionId === 'partners-section') {
            document.querySelector('.nav-link[onclick="showSection(\'partners-section\')"]').classList.add('active');
            updateBreadcrumb('Partners');
        }
    }

    function updateBreadcrumb(text, append = false, onClickFn = null) {
        const bc = document.getElementById('breadcrumbs');
        if(!append) {
            bc.innerHTML = `<li class="breadcrumb-item active">${text}</li>`;
        } else {
            // Change last active to link
            const last = bc.lastElementChild;
            last.classList.remove('active');
            const oldText = last.innerText;
            // This is a simplified breadcrumb logic; for robust apps, use a stack
            if(onClickFn) {
                last.innerHTML = `<a onclick="${onClickFn}">${oldText}</a>`;
            }
            bc.innerHTML += `<li class="breadcrumb-item active">${text}</li>`;
        }
    }

    function openModal(id) {
        const form = document.querySelector(`#${id} form`);
        if(form) {
            form.reset();
            const hiddenId = form.querySelector('input[type="hidden"]');
            if(hiddenId) hiddenId.value = '';
        }
        new bootstrap.Modal(document.getElementById(id)).show();
    }

    // --- Movies Logic ---
    async function loadMovies() {
        const data = await apiCall('/movies');
        if (data) {
            globalMovies = data;
            document.getElementById('movies-table-body').innerHTML = data.map(m => `
                <tr>
                    <td>${m.id}</td>
                    <td><span class="fw-bold">${m.title}</span></td>
                    <td><span class="badge bg-secondary">${m.genre || 'N/A'}</span></td>
                    <td>${m.durationMinutes} min</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="editMovie(${m.id})">Edit</button></td>
                </tr>
            `).join('');
        }
    }

    function editMovie(id) {
        const m = globalMovies.find(x => x.id === id);
        if(!m) return;
        document.getElementById('movieId').value = m.id;
        document.getElementById('movieTitle').value = m.title;
        document.getElementById('movieGenre').value = m.genre;
        document.getElementById('movieDuration').value = m.durationMinutes;
        document.getElementById('movieDesc').value = m.description;
        new bootstrap.Modal(document.getElementById('movieModal')).show();
    }

    async function saveMovie() {
        const id = document.getElementById('movieId').value;
        const body = {
            title: document.getElementById('movieTitle').value,
            genre: document.getElementById('movieGenre').value,
            durationMinutes: parseInt(document.getElementById('movieDuration').value),
            description: document.getElementById('movieDesc').value
        };
        const res = await apiCall(id ? `/movies/${id}` : '/movies', id ? 'PUT' : 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('movieModal')).hide();
            loadMovies();
            showAlert('success', 'Movie saved successfully');
        }
    }

    // --- Partner Logic ---
    async function loadPartners() {
        const data = await apiCall('/partners');
        if (data) {
            globalPartners = data;
            document.getElementById('partners-table-body').innerHTML = data.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td><span class="fw-bold text-primary">${p.name}</span></td>
                    <td>${p.contactEmail}</td>
                    <td><code>${p.apiKey}</code></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewTheatres(${p.id}, '${p.name}')">
                            <i class="bi bi-geo-alt"></i> Manage Theatres
                        </button>
                    </td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="editPartner(${p.id})"><i class="bi bi-pencil"></i></button></td>
                </tr>
            `).join('');
        }
    }

    function editPartner(id) {
        const p = globalPartners.find(x => x.id === id);
        document.getElementById('partnerId').value = p.id;
        document.getElementById('partnerName').value = p.name;
        document.getElementById('partnerEmail').value = p.contactEmail;
        document.getElementById('partnerApiKey').value = p.apiKey;
        new bootstrap.Modal(document.getElementById('partnerModal')).show();
    }

    async function savePartner() {
        const id = document.getElementById('partnerId').value;
        const body = {
            name: document.getElementById('partnerName').value,
            contactEmail: document.getElementById('partnerEmail').value,
            apiKey: document.getElementById('partnerApiKey').value
        };
        const res = await apiCall(id ? `/partners/${id}` : '/partners', id ? 'PUT' : 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('partnerModal')).hide();
            loadPartners();
            showAlert('success', 'Partner saved');
        }
    }

    // --- Theatre Logic ---
    async function viewTheatres(partnerId, partnerName) {
        currentPartnerId = partnerId;
        document.getElementById('theatre-partner-name').innerText = `Partner: ${partnerName}`;

        // Reset Breadcrumb to: Partners > [Partner Name]
        const bc = document.getElementById('breadcrumbs');
        bc.innerHTML = `
            <li class="breadcrumb-item"><a onclick="showSection('partners-section')">Partners</a></li>
            <li class="breadcrumb-item active">${partnerName}</li>
        `;

        showSection('theatres-section');
        loadTheatres();
    }

    async function loadTheatres() {
        const data = await apiCall(`/partners/${currentPartnerId}/theatres`);
        if(data) {
            globalTheatres = data;
            document.getElementById('theatres-table-body').innerHTML = data.map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.name}</td>
                    <td>${t.city}</td>
                    <td>${t.address}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewTheatreDashboard(${t.id}, '${t.name}')">
                            <i class="bi bi-gear"></i> Manage Screens & Shows
                        </button>
                    </td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="editTheatre(${t.id})"><i class="bi bi-pencil"></i></button></td>
                </tr>
            `).join('');
        }
    }

    function editTheatre(id) {
        const t = globalTheatres.find(x => x.id === id);
        document.getElementById('theatreId').value = t.id;
        document.getElementById('theatreName').value = t.name;
        document.getElementById('theatreCity').value = t.city;
        document.getElementById('theatreAddress').value = t.address;
        new bootstrap.Modal(document.getElementById('theatreModal')).show();
    }

    async function saveTheatre() {
        const id = document.getElementById('theatreId').value;
        const body = {
            name: document.getElementById('theatreName').value,
            city: document.getElementById('theatreCity').value,
            address: document.getElementById('theatreAddress').value
        };
        const url = id ? `/partners/${currentPartnerId}/theatres/${id}` : `/partners/${currentPartnerId}/theatres`;
        const res = await apiCall(url, id ? 'PUT' : 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('theatreModal')).hide();
            loadTheatres();
            showAlert('success', 'Theatre saved');
        }
    }

    // --- Screens & Shows Dashboard ---
    async function viewTheatreDashboard(theatreId, theatreName) {
        currentTheatreId = theatreId;
        document.getElementById('dashboard-theatre-name').innerText = theatreName;

        // Fix breadcrumb: Partners > [Back to Partner] > Theatre Name
        const bc = document.getElementById('breadcrumbs');
        // Note: We need the partner name again, but we can assume context is preserved
        const partnerNameItem = bc.children[1];
        if(partnerNameItem) {
            const partnerName = partnerNameItem.innerText;
            // Make partner name clickable to go back to theatre list
            partnerNameItem.innerHTML = `<a onclick="showSection('theatres-section')">${partnerName}</a>`;
            partnerNameItem.classList.remove('active');
        }
        bc.innerHTML += `<li class="breadcrumb-item active">${theatreName}</li>`;

        showSection('theatre-dashboard-section');
        new bootstrap.Tab(document.querySelector('#screens-tab')).show();
        loadScreens();
    }

    // --- Screens Logic ---
    async function loadScreens() {
        // GET /api/theatres/{theatreId}/screens
        const data = await apiCall(`/theatres/${currentTheatreId}/screens`);
        if(data) {
            globalScreens = data;
            document.getElementById('screens-table-body').innerHTML = data.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.totalSeats}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editScreen(${s.id})">Edit</button>
                    </td>
                </tr>
            `).join('');
        }
    }

    function editScreen(id) {
        const s = globalScreens.find(x => x.id === id);
        document.getElementById('screenId').value = s.id;
        document.getElementById('screenName').value = s.name;
        document.getElementById('screenSeats').value = s.totalSeats;
        new bootstrap.Modal(document.getElementById('screenModal')).show();
    }

    async function saveScreen() {
        const id = document.getElementById('screenId').value;
        const body = {
            name: document.getElementById('screenName').value,
            totalSeats: parseInt(document.getElementById('screenSeats').value)
        };
        const url = id ? `/theatres/${currentTheatreId}/screens/${id}` : `/theatres/${currentTheatreId}/screens`;
        const res = await apiCall(url, id ? 'PUT' : 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('screenModal')).hide();
            loadScreens();
            showAlert('success', 'Screen saved');
        }
    }

    // --- Shows Logic ---
    async function loadShows() {
        // GET /api/partners/{pid}/theatres/{tid}/shows
        const data = await apiCall(`/partners/${currentPartnerId}/theatres/${currentTheatreId}/shows`);
        if(data) {
            document.getElementById('shows-table-body').innerHTML = data.map(s => {
                const movie = globalMovies.find(m => m.id === s.movieId);
                const screen = globalScreens.find(sc => sc.id === s.screenId);
                const mTitle = movie ? movie.title : `Movie #${s.movieId}`;
                const sName = screen ? screen.name : `Screen #${s.screenId}`;
                const start = new Date(s.startTime).toLocaleString('en-US', { weekday:'short', hour:'numeric', minute:'numeric' });

                return `
                <tr>
                    <td>${s.id}</td>
                    <td>${mTitle}</td>
                    <td>${sName}</td>
                    <td>${start}</td>
                    <td>$${s.basePrice}</td>
                    <td>
                       <button class="btn btn-sm btn-danger" onclick="deleteShow(${s.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
        }
    }

    function prepareAddShowModal() {
        // Ensure screens are loaded
        if(!globalScreens.length) {
            alert("No screens found! Please add screens to this theatre first.");
            return;
        }

        // Populate Dropdowns
        const screenSelect = document.getElementById('showScreenSelect');
        const movieSelect = document.getElementById('showMovieSelect');

        screenSelect.innerHTML = globalScreens.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        movieSelect.innerHTML = globalMovies.map(m => `<option value="${m.id}">${m.title}</option>`).join('');

        openModal('showModal');
    }

    async function saveShow() {
        const screenId = document.getElementById('showScreenSelect').value;
        const body = {
            movieId: parseInt(document.getElementById('showMovieSelect').value),
            startTime: document.getElementById('showStartTime').value, // ISO format from input
            endTime: document.getElementById('showEndTime').value,
            basePrice: parseFloat(document.getElementById('showPrice').value)
        };

        // POST /api/partners/{pid}/theatres/{tid}/screens/{sid}/shows
        const url = `/partners/${currentPartnerId}/theatres/${currentTheatreId}/screens/${screenId}/shows`;

        const res = await apiCall(url, 'POST', body);
        if(res) {
            bootstrap.Modal.getInstance(document.getElementById('showModal')).hide();
            loadShows();
            showAlert('success', 'Show created successfully');
        }
    }

    async function deleteShow(showId) {
        if(!confirm("Are you sure you want to delete this show?")) return;
        const res = await apiCall(`/partners/${currentPartnerId}/theatres/${currentTheatreId}/shows/${showId}`, 'DELETE');
        loadShows();
        showAlert('warning', 'Show deleted');
    }

</script>
</body>
</html>