<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeatSaga - Book Movie Tickets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        /* Progress Steps */
        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
        }
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step.active {
            background: #007bff;
            color: white;
            transform: scale(1.1);
        }
        .step.inactive {
            background: #e9ecef;
            color: #6c757d;
        }
        .step-line {
            height: 2px;
            width: 50px;
            background: #e9ecef;
        }

        /* Seat Styles */
        .seat-container {
            display: grid;
            gap: 10px;
            justify-content: center;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            max-width: 500px;
        }
        .seat {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .seat.available {
            background: #d1ecf1;
            border-color: #0dcaf0;
            color: #0c5460;
        }
        .seat.selected {
            background: #28a745;
            color: white;
            border-color: #218838;
            transform: scale(1.1);
        }
        .seat.booked {
            background: #dc3545;
            color: white;
            border-color: #bd2130;
            cursor: not-allowed;
        }
        .seat.vip { background: #ffc107; border-color: #ffc107; }
        .seat.premium { background: #17a2b8; border-color: #17a2b8; }
        .seat.recliner { background: #6f42c1; border-color: #6f42c1; }

        .screen {
            background: #333;
            color: white;
            padding: 15px;
            text-align: center;
            margin: 30px 0;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.2rem;
            letter-spacing: 2px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #007bff;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="text-white mb-1">
                        <i class="bi bi-film"></i> SeatSaga
                    </h1>
                    <p class="text-white-50 mb-0">Book movie tickets easily</p>
                </div>
                <div>
                    <a href="dashboard.html" class="btn btn-light btn-sm me-2">
                        <i class="bi bi-house"></i> Dashboard
                    </a>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>

            <div class="main-card p-4">
                <!-- Progress Steps -->
                <div class="step-indicator">
                    <div class="step active">1</div>
                    <div class="step-line"></div>
                    <div class="step inactive">2</div>
                    <div class="step-line"></div>
                    <div class="step inactive">3</div>
                </div>
                <div class="text-center mb-4">
                    <span class="badge bg-primary">Search Shows</span>
                    <span class="text-muted mx-2">→</span>
                    <span class="badge bg-secondary">Select Seats</span>
                    <span class="text-muted mx-2">→</span>
                    <span class="badge bg-secondary">Confirm Booking</span>
                </div>

                <!-- STEP 1: Search Shows -->
                <div id="step-1">
                    <h3 class="mb-4"><i class="bi bi-search me-2"></i> Find Your Show</h3>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">City</label>
                            <select class="form-select" id="citySelect">
                                <option value="">Select City</option>
                                <!-- Cities will be loaded dynamically -->
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Movie</label>
                            <select class="form-select" id="movieSelect">
                                <option value="">Select Movie</option>
                                <!-- Movies will be loaded dynamically -->
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="dateSelect" value="">
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg px-5" onclick="searchShows()">
                            <i class="bi bi-search me-2"></i> Search Shows
                        </button>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="mt-5" style="display: none;">
                        <h4 class="mb-3">Available Shows</h4>
                        <div id="showsList" class="list-group">
                            <!-- Shows will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Select Seats -->
                <div id="step-2" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-ticket-perforated me-2"></i> Select Your Seats</h3>
                        <button class="btn btn-outline-secondary" onclick="backToSearch()">
                            <i class="bi bi-arrow-left"></i> Back to Search
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <!-- Show Info -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 id="showMovieTitle" class="card-title"></h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Theatre:</small>
                                            <p id="showTheatreName" class="fw-bold mb-1"></p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Time:</small>
                                            <p id="showTime" class="fw-bold mb-1"></p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Screen:</small>
                                            <p id="showScreenName" class="fw-bold mb-1"></p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Price:</small>
                                            <p id="showBasePrice" class="fw-bold mb-1"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Seat Map -->
                            <div class="text-center">
                                <div class="screen">SCREEN</div>
                                <div id="seatMap" class="seat-container">
                                    <!-- Seats will be generated here -->
                                </div>

                                <div class="mt-4">
                                    <div class="d-inline-flex align-items-center me-4">
                                        <div class="seat available me-2"></div>
                                        <span>Available</span>
                                    </div>
                                    <div class="d-inline-flex align-items-center me-4">
                                        <div class="seat selected me-2"></div>
                                        <span>Selected</span>
                                    </div>
                                    <div class="d-inline-flex align-items-center">
                                        <div class="seat booked me-2"></div>
                                        <span>Booked</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <!-- Booking Summary -->
                            <div class="summary-card">
                                <h5><i class="bi bi-receipt me-2"></i> Booking Summary</h5>

                                <div class="mb-3">
                                    <small class="text-muted">Selected Seats:</small>
                                    <div id="selectedSeatsList" class="mt-1">
                                        <span class="badge bg-secondary">None selected</span>
                                    </div>
                                </div>

                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span>Seats (<span id="seatCount">0</span>):</span>
                                    <span>$<span id="seatTotal">0.00</span></span>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <span>Service Fee:</span>
                                    <span>$<span id="serviceFee">2.00</span></span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>Total:</span>
                                    <span>$<span id="totalAmount">2.00</span></span>
                                </div>

                                <button class="btn btn-success btn-lg w-100 mt-4" onclick="proceedToBooking()" disabled id="bookButton">
                                    <i class="bi bi-lock"></i> Proceed to Payment
                                </button>

                                <div class="alert alert-warning mt-3 small">
                                    <i class="bi bi-info-circle"></i> Selected seats will be locked for 10 minutes
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: Confirm Booking -->
                <div id="step-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-check-circle me-2"></i> Confirm Booking</h3>
                        <button class="btn btn-outline-secondary" onclick="backToSeatSelection()">
                            <i class="bi bi-arrow-left"></i> Back to Seats
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Booking Details</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-4 text-center">
                                            <div class="mb-2">
                                                <small class="text-muted">Movie</small>
                                                <h5 id="confirmMovieTitle"></h5>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="mb-2">
                                                <small class="text-muted">Theatre & Time</small>
                                                <h5 id="confirmTheatreTime"></h5>
                                                <p id="confirmScreen" class="text-muted small"></p>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="mb-2">
                                                <small class="text-muted">Seats</small>
                                                <h5 id="confirmSeatsCount"></h5>
                                                <p id="confirmSeatsList" class="text-muted small"></p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        Complete payment to confirm your booking
                                    </div>

                                    <!-- Payment Method -->
                                    <div class="mb-4">
                                        <h5>Payment Method</h5>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="paymentMethod" id="cardPayment" checked>
                                            <label class="form-check-label" for="cardPayment">
                                                <i class="bi bi-credit-card"></i> Credit/Debit Card
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="paymentMethod" id="upiPayment">
                                            <label class="form-check-label" for="upiPayment">
                                                <i class="bi bi-phone"></i> UPI
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Card Details -->
                                    <div id="cardDetails">
                                        <h5>Card Details</h5>
                                        <div class="row g-3">
                                            <div class="col-md-12">
                                                <label class="form-label">Card Number</label>
                                                <input type="text" class="form-control" placeholder="1234 5678 9012 3456">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Expiry</label>
                                                <input type="text" class="form-control" placeholder="MM/YY">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">CVV</label>
                                                <input type="text" class="form-control" placeholder="123">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="summary-card">
                                <h5><i class="bi bi-receipt me-2"></i> Payment Summary</h5>

                                <table class="table table-borderless">
                                    <tbody>
                                    <tr>
                                        <td>Ticket Price:</td>
                                        <td class="text-end">$<span id="confirmTicketPrice">0.00</span></td>
                                    </tr>
                                    <tr>
                                        <td>Convenience Fee:</td>
                                        <td class="text-end">$<span id="confirmConvFee">2.00</span></td>
                                    </tr>
                                    <tr>
                                        <td>Taxes:</td>
                                        <td class="text-end">$<span id="confirmTaxes">1.50</span></td>
                                    </tr>
                                    <tr class="border-top">
                                        <td class="fw-bold">Total Amount:</td>
                                        <td class="text-end fw-bold">$<span id="confirmTotal">3.50</span></td>
                                    </tr>
                                    </tbody>
                                </table>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="termsCheck">
                                    <label class="form-check-label small" for="termsCheck">
                                        I agree to the Terms & Conditions
                                    </label>
                                </div>

                                <button class="btn btn-primary btn-lg w-100" onclick="confirmBooking()" id="confirmButton">
                                    <i class="bi bi-lock-fill"></i> Confirm & Pay $<span id="payAmount">0.00</span>
                                </button>

                                <div class="alert alert-warning mt-3 small">
                                    <i class="bi bi-shield-check"></i> Secure payment
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SUCCESS Message -->
                <div id="success" style="display: none;">
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h2 class="text-success mb-3">Booking Confirmed!</h2>
                        <div class="card mx-auto mt-4" style="max-width: 400px;">
                            <div class="card-body">
                                <h5 class="card-title">Booking Details</h5>
                                <p class="mb-1"><strong>Booking ID:</strong> <span id="bookingRef"></span></p>
                                <p class="mb-1"><strong>Show:</strong> <span id="successMovie"></span></p>
                                <p class="mb-1"><strong>Seats:</strong> <span id="successSeats"></span></p>
                                <p class="mb-1"><strong>Amount Paid:</strong> $<span id="successAmount"></span></p>
                                <p class="mb-0"><strong>Status:</strong> <span class="badge bg-success">CONFIRMED</span></p>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-primary me-2" onclick="startNewBooking()">
                                <i class="bi bi-plus-circle me-1"></i> Book Another Show
                            </button>
                            <a href="dashboard.html" class="btn btn-outline-primary">
                                <i class="bi bi-house me-1"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Configuration
    const API_BASE = '/api';
    let selectedShow = null;
    let selectedSeats = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadCities();
        loadMovies();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateSelect').value = today;
    });

    // Navigation functions
    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('userToken');
            localStorage.removeItem('bookingData');
            window.location.href = 'index.html';
        }
    }

    // Update progress steps
    function updateProgress(step) {
        // Update steps
        document.querySelectorAll('.step').forEach((s, index) => {
            s.classList.remove('active');
            s.classList.add('inactive');
            if (index < step) {
                s.classList.remove('inactive');
                s.classList.add('active');
            }
        });

        // Update badges
        document.querySelectorAll('.step-indicator + .text-center .badge').forEach((b, index) => {
            b.classList.remove('bg-primary');
            b.classList.add('bg-secondary');
            if (index < step) {
                b.classList.remove('bg-secondary');
                b.classList.add('bg-primary');
            }
        });
    }

    // Load available cities
    async function loadCities() {
        try {
            const res = await fetch(`${API_BASE}/cities`);
            if (res.ok) {
                const cities = await res.json();
                const select = document.getElementById('citySelect');
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    select.appendChild(option);
                });
            } else {
                // Fallback cities
                const fallbackCities = ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix'];
                const select = document.getElementById('citySelect');
                fallbackCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    select.appendChild(option);
                });
            }
        } catch (err) {
            console.error('Failed to load cities:', err);
            const fallbackCities = ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix'];
            const select = document.getElementById('citySelect');
            fallbackCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
        }
    }

    // Load movies
    async function loadMovies() {
        try {
            const res = await fetch(`${API_BASE}/movies`);
            const movies = await res.json();
            const select = document.getElementById('movieSelect');
            movies.forEach(movie => {
                const option = document.createElement('option');
                option.value = movie.id;
                option.textContent = `${movie.title} (${movie.durationMinutes} min)`;
                select.appendChild(option);
            });
        } catch (err) {
            console.error('Failed to load movies:', err);
        }
    }

    // Search shows
    async function searchShows() {
        const city = document.getElementById('citySelect').value;
        const movieId = document.getElementById('movieSelect').value;
        const dateInput = document.getElementById('dateSelect').value;

        if (!city || !movieId) {
            alert('Please select city and movie');
            return;
        }

        try {
            // Format date
            let date = dateInput;
            if (!date) {
                const today = new Date();
                date = today.toISOString().split('T')[0];
            }

            const url = `${API_BASE}/shows/search?city=${encodeURIComponent(city)}&movieId=${movieId}&date=${date}`;
            console.log('Fetching from:', url);

            const res = await fetch(url, {
                headers: { 'accept': '*/*' }
            });

            if (!res.ok) {
                throw new Error(`API Error: ${res.status}`);
            }

            const theatres = await res.json();
            console.log('Received data:', theatres);

            displaySearchResults(theatres);
        } catch (err) {
            console.error('Search failed:', err);
            alert(`Failed to search shows: ${err.message}`);
        }
    }

    // Display search results
    function displaySearchResults(theatres) {
        const container = document.getElementById('showsList');
        container.innerHTML = '';

        if (!theatres || theatres.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No shows found for your search</div>';
            document.getElementById('searchResults').style.display = 'block';
            return;
        }

        theatres.forEach(theatre => {
            const theatreCard = document.createElement('div');
            theatreCard.className = 'card mb-3';
            theatreCard.innerHTML = `
            <div class="card-body">
                <h5 class="card-title">${theatre.theatreName}</h5>
                <p class="card-text text-muted">${theatre.address}</p>
                <div class="mt-3">
                    <h6>Show Times:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        ${theatre.shows.map(show => `
                            <button class="btn btn-outline-primary btn-sm"
                                    onclick="selectShow(${show.showId}, ${theatre.theatreId}, '${theatre.theatreName}', '${show.screenName}', '${show.startTime}', ${show.basePrice || 15})">
                                ${formatTime(show.startTime)} - $${show.basePrice || 15}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
            container.appendChild(theatreCard);
        });

        document.getElementById('searchResults').style.display = 'block';
    }

    // Format time
    function formatTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    // Select a show
    function selectShow(showId, theatreId, theatreName, screenName, startTime, price) {
        selectedShow = { showId, theatreId, theatreName, screenName, startTime, price };

        // Update step 2 display
        const movieTitle = document.getElementById('movieSelect').selectedOptions[0]?.text.split(' (')[0] || "Movie";
        document.getElementById('showMovieTitle').textContent = movieTitle;
        document.getElementById('showTheatreName').textContent = theatreName;
        document.getElementById('showScreenName').textContent = screenName;
        document.getElementById('showTime').textContent = formatTime(startTime);
        document.getElementById('showBasePrice').textContent = `$${price}`;

        // Switch to step 2
        document.getElementById('step-1').style.display = 'none';
        document.getElementById('step-2').style.display = 'block';
        updateProgress(2);

        // Load seats for this show
        loadSeats(showId);
    }

    // Back to search
    function backToSearch() {
        selectedShow = null;
        selectedSeats = [];

        document.getElementById('step-2').style.display = 'none';
        document.getElementById('step-1').style.display = 'block';
        updateProgress(1);

        document.getElementById('searchResults').style.display = 'none';
    }

    // Load seats for a show
    async function loadSeats(showId) {
        try {
            const seatMap = document.getElementById('seatMap');
            seatMap.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-primary"></div><p class="mt-2">Loading seats...</p></div>';

            // First, get show details to get screen ID
            const showRes = await fetch(`${API_BASE}/shows/${showId}`);
            if (!showRes.ok) {
                throw new Error('Failed to fetch show details');
            }

            const showDetails = await showRes.json();
            const screenId = showDetails.screenId;
            const theatreId = showDetails.theatreId;

            // Get screen layout
            const screenRes = await fetch(`${API_BASE}/theatres/${theatreId}/screens/${screenId}`);
            if (!screenRes.ok) {
                throw new Error('Failed to fetch screen layout');
            }

            const screenData = await screenRes.json();

            // Get actual seat statuses
            const seatsRes = await fetch(`${API_BASE}/shows/${showId}/seats`);
            const seats = await seatsRes.json();

            // Create seat map from layout
            displaySeatMapFromLayout(screenData, seats);

        } catch (err) {
            console.error('Failed to load seats:', err);
            createDummySeatMap();
        }
    }

    // Display seat map from layout
    // Display seat map from layout
    function displaySeatMapFromLayout(screenData, existingSeats) {
        const seatMap = document.getElementById('seatMap');
        seatMap.innerHTML = '';

        // Parse the seat layout JSON
        let layout;
        try {
            layout = JSON.parse(screenData.seatLayoutJson);
        } catch (e) {
            console.error('Failed to parse layout JSON:', e);
            createDummySeatMap();
            return;
        }

        // Create a map of existing seats for quick lookup
        const seatMapByRowSeat = {};
        existingSeats.forEach(seat => {
            const key = `${seat.rowNumber}-${seat.seatNumber}`;
            seatMapByRowSeat[key] = seat;
        });

        // Find max seats per row for grid layout
        let maxSeats = 0;
        layout.rows.forEach(row => {
            maxSeats = Math.max(maxSeats, row.seatCount);
        });

        // Set grid columns
        seatMap.style.gridTemplateColumns = `repeat(${maxSeats}, 40px)`;

        // Create seat grid from layout
        layout.rows.forEach(row => {
            for (let i = 1; i <= row.seatCount; i++) {
                const seatElement = document.createElement('div');
                const key = `${row.row}-${i}`;
                const existingSeat = seatMapByRowSeat[key];

                if (existingSeat) {
                    // Seat exists in database
                    seatElement.className = `seat ${existingSeat.status.toLowerCase()}`;
                    seatElement.dataset.seatId = existingSeat.id; // Numeric ID (e.g., 31)
                    seatElement.dataset.seatLabel = `${row.row}-${i}`; // Add this: "A-1"
                    seatElement.dataset.price = existingSeat.price;
                    seatElement.title = `Row ${row.row}, Seat ${i} - $${existingSeat.price}`;

                    if (existingSeat.status === 'AVAILABLE') {
                        seatElement.onclick = () => toggleSeatSelection(seatElement);
                    } else {
                        seatElement.classList.add('booked');
                    }
                } else {
                    // Seat doesn't exist in database (should be created)
                    seatElement.className = 'seat available';
                    seatElement.dataset.seatId = `${row.row}-${i}`; // String ID "A-1"
                    seatElement.dataset.seatLabel = `${row.row}-${i}`; // Add this too
                    seatElement.dataset.price = selectedShow.price;
                    seatElement.title = `${row.row}${i} - $${selectedShow.price}`;
                    seatElement.onclick = () => toggleSeatSelection(seatElement);
                }

                // Add seat type class
                if (row.seatType) {
                    seatElement.classList.add(row.seatType.toLowerCase());
                }

                seatElement.textContent = i;
                seatMap.appendChild(seatElement);
            }
        });
    }
    // Create dummy seat map (fallback)
    // Create dummy seat map (fallback)
    function createDummySeatMap() {
        const seatMap = document.getElementById('seatMap');
        seatMap.innerHTML = '';
        seatMap.style.gridTemplateColumns = 'repeat(5, 40px)';

        const rows = ['A', 'B', 'C', 'D'];
        rows.forEach(row => {
            for (let i = 1; i <= 5; i++) {
                const seat = document.createElement('div');
                seat.className = 'seat available';
                seat.textContent = i;
                seat.dataset.seatId = `${row}-${i}`;
                seat.dataset.seatLabel = `${row}-${i}`; // Add this line
                seat.dataset.price = selectedShow.price;
                seat.title = `${row}${i} - $${selectedShow.price}`;

                if (Math.random() > 0.7) {
                    seat.className = 'seat booked';
                } else {
                    seat.onclick = () => toggleSeatSelection(seat);
                }

                seatMap.appendChild(seat);
            }
        });
    }

    // Toggle seat selection
    function toggleSeatSelection(seatElement) {
        const seatId = seatElement.dataset.seatId;
        const seatLabel = seatElement.dataset.seatLabel || `${seatElement.dataset.seatId}`; // Use seatLabel if available
        const seatPrice = parseFloat(seatElement.dataset.price);

        if (seatElement.classList.contains('selected')) {
            // Deselect
            seatElement.classList.remove('selected');
            seatElement.classList.add('available');
            selectedSeats = selectedSeats.filter(s => s.id !== seatId);
        } else {
            // Select
            seatElement.classList.remove('available');
            seatElement.classList.add('selected');
            selectedSeats.push({
                id: seatId,
                label: seatLabel, // Use seatLabel instead of seatElement.textContent
                price: seatPrice
            });
        }

        updateBookingSummary();
    }

    // Update booking summary
    function updateBookingSummary() {
        const seatList = document.getElementById('selectedSeatsList');
        const seatCount = selectedSeats.length;
        const seatTotal = selectedSeats.reduce((sum, seat) => sum + seat.price, 0);
        const serviceFee = 2.00;
        const totalAmount = seatTotal + serviceFee;

        // Update selected seats display
        if (seatCount === 0) {
            seatList.innerHTML = '<span class="badge bg-secondary">None selected</span>';
        } else {
            seatList.innerHTML = selectedSeats.map(seat =>
                `<span class="badge bg-success me-1 mb-1">${seat.label}</span>`
            ).join('');
        }

        // Update prices
        document.getElementById('seatCount').textContent = seatCount;
        document.getElementById('seatTotal').textContent = seatTotal.toFixed(2);
        document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);

        // Enable/disable book button
        document.getElementById('bookButton').disabled = seatCount === 0;
    }

    // Proceed to booking
    function proceedToBooking() {
        if (selectedSeats.length === 0) {
            alert('Please select at least one seat');
            return;
        }

        // Update confirmation details
        const movieTitle = document.getElementById('movieSelect').selectedOptions[0]?.text.split(' (')[0] || "Movie";
        document.getElementById('confirmMovieTitle').textContent = movieTitle;

        const showTime = formatTime(selectedShow.startTime);
        document.getElementById('confirmTheatreTime').textContent = `${selectedShow.theatreName} | ${showTime}`;
        document.getElementById('confirmScreen').textContent = `Screen: ${selectedShow.screenName}`;

        document.getElementById('confirmSeatsCount').textContent = `${selectedSeats.length} seats`;
        document.getElementById('confirmSeatsList').textContent = selectedSeats.map(s => s.label).join(', ');

        // Calculate prices
        const ticketPrice = selectedSeats.reduce((sum, seat) => sum + seat.price, 0);
        const convenienceFee = 2.00;
        const taxes = ticketPrice * 0.18;
        const totalAmount = ticketPrice + convenienceFee + taxes;

        document.getElementById('confirmTicketPrice').textContent = ticketPrice.toFixed(2);
        document.getElementById('confirmTaxes').textContent = taxes.toFixed(2);
        document.getElementById('confirmTotal').textContent = totalAmount.toFixed(2);
        document.getElementById('payAmount').textContent = totalAmount.toFixed(2);

        // Switch to step 3
        document.getElementById('step-2').style.display = 'none';
        document.getElementById('step-3').style.display = 'block';
        updateProgress(3);
    }

    // Back to seat selection
    function backToSeatSelection() {
        document.getElementById('step-3').style.display = 'none';
        document.getElementById('step-2').style.display = 'block';
        updateProgress(2);
    }

    // Confirm booking and make API call
    async function confirmBooking() {
        const termsCheck = document.getElementById('termsCheck');
        if (!termsCheck.checked) {
            alert('Please agree to the Terms & Conditions');
            return;
        }

        // Prepare booking request
        const bookingRequest = {
            showId: selectedShow.showId,
            seatIds: selectedSeats.map(seat => seat.label),
            totalAmount: parseFloat(document.getElementById('confirmTotal').textContent)
        };

        try {
            // Show loading
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
            confirmButton.disabled = true;

            // Call booking API
            const response = await fetch(`${API_BASE}/bookings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingRequest)
            });

            if (response.ok) {
                const bookingResponse = await response.json();
                showBookingSuccess(bookingResponse);
            } else {
                throw new Error('Booking failed');
            }
        } catch (error) {
            console.error('Booking error:', error);
            alert('Booking failed. Please try again.');

            // Reset button
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.innerHTML = `<i class="bi bi-lock-fill"></i> Confirm & Pay $${document.getElementById('payAmount').textContent}`;
            confirmButton.disabled = false;
        }
    }

    // Show booking success
    function showBookingSuccess(bookingResponse) {
        // Hide payment step, show success
        document.getElementById('step-3').style.display = 'none';
        document.getElementById('success').style.display = 'block';

        // Update success message
        document.getElementById('bookingRef').textContent = bookingResponse.bookingReference || 'BSG-' + Date.now().toString().slice(-8);
        document.getElementById('successMovie').textContent = document.getElementById('confirmMovieTitle').textContent;
        document.getElementById('successSeats').textContent = selectedSeats.map(s => s.label).join(', ');
        document.getElementById('successAmount').textContent = document.getElementById('confirmTotal').textContent;
    }

    // Start new booking
    function startNewBooking() {
        selectedShow = null;
        selectedSeats = [];

        document.getElementById('success').style.display = 'none';
        document.getElementById('step-1').style.display = 'block';
        document.getElementById('searchResults').style.display = 'none';

        // Reset form
        document.getElementById('citySelect').value = '';
        document.getElementById('movieSelect').value = '';
        document.getElementById('dateSelect').value = new Date().toISOString().split('T')[0];

        updateProgress(1);
    }
</script>
</body>
</html>